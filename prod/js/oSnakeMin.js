(function($,undefined){function PickUp(type){Cache.pickUps.push(this);this.type=type;if(type==="human"){this.type="human";Cache.session.humanCount+=1}else{if(type==="powerUp"){var generateType,pUpType,pUpTypes=["dblPoints","shrink","slowTime","invincible"];generateType=function(){return pUpTypes[Math.floor(Math.random()*pUpTypes.length)]};pUpType=generateType();this.type=(pUpType==="invincible")?generateType():pUpType;Cache.session.displayedPowerUp=this}else{if(type==="portal"){this.type="portal"}}}this.$html=$("<div class='pickUp "+this.type+"'></div>");this.tilePos=[0,0]}PickUp.toggleSmile=function(triggerObj){for(var i=0,j=Cache.pickUps.length;i<j;i++){if(Cache.pickUps[i].type==="human"){var human=Cache.pickUps[i];if(Math.abs(triggerObj.tilePos[0]-human.tilePos[0])<4&&Math.abs(triggerObj.tilePos[1]-human.tilePos[1])<4){human.$html.addClass("frown")}else{human.$html.removeClass("frown")}}}};PickUp.togglePowerUp=function(){if(Cache.session.activePowerUp){Cache.session.activePowerUp.togglePowerUp()}else{if(Cache.session.displayedPowerUp){Cache.session.displayedPowerUp.destroy()}else{(new PickUp("powerUp")).create()}Engine.powerUpToggleTime=Engine.time}};PickUp.prototype={create:function(givenTilePos){var tilePos=(givenTilePos)?givenTilePos:Helpers.findEmptyTile();this.tilePos[0]=tilePos[0];this.tilePos[1]=tilePos[1];if(this.type==="human"){this.$html.addClass("smile")}else{if(this.type==="powerUp"){this.$html.addClass(this.type)}}Helpers.drawObjToTile(this,true);$("#level_"+Cache.session.level).append(this.$html);return this},destroy:function(keepHtml){Cache.tiles[this.tilePos[0]][this.tilePos[1]].obj=undefined;if(this.type==="human"){Cache.session.humanCount-=1}else{if(this.type!=="portal"&&this.type!=="human"){Cache.session.displayedPowerUp=false}}for(var i=0,j=Cache.pickUps.length;i<j;i++){if(this===Cache.pickUps[i]){Cache.pickUps.splice(i,1)}}if(!keepHtml){this.$html.remove()}},togglePowerUp:function(){Engine.powerUpToggleTime=Engine.time;if(Cache.session.activePowerUp){Cache.session.activePowerUp=false;if(this.type!=="shrink"){$(".head").removeClass("pickUp "+this.type)}if(document.getElementById("powerUpTimeBar")){$("#powerUpTimeBar").stop();$("#powerUpTimeBar").remove()}}else{Cache.session.activePowerUp=this;if(this.type!=="shrink"){$(".head").addClass("pickUp "+this.type)}}switch(this.type){case"dblPoints":if(Cache.session.activePowerUp){Engine.activeDblPoints=true;View.powerUpTimeBar(Engine.powerUpDuration)}else{Engine.activeDblPoints=false}break;case"shrink":if(Cache.session.activePowerUp){if(Snake.segsToKill[0]){Snake.removeDeadSegments()}if(Snake.segments.length>3){Snake.killSegments(3)}}break;case"slowTime":if(Cache.session.activePowerUp){Snake.speed*=2;View.powerUpTimeBar(Engine.powerUpDuration)}else{Snake.speed/=2}break;case"invincible":var speed=(Cache.session.difficulty==="challenge")?0.5:0.65;if(Cache.session.activePowerUp){Snake.invincible=true;Snake.speed*=speed;View.powerUpTimeBar(Engine.powerUpDuration)}else{Snake.invincible=false;Snake.speed/=speed}break}}};function Wall(givenTilePos){Cache.walls.push(this);this.$html=$("<div class='wall'></div>");this.tilePos=givenTilePos;this.hasBomb=false;this.direction=undefined}Wall.generateWallPattern=function(wallsToCreate){var parentWall,freeDirections,currDirection,newTilePos,validPos,seed=4,i=0,allDirections=[1,2,3,4],bannedPosns=[];validPos=function(pos,badPosns){for(var i=0,j=badPosns.length;i<j;i++){if(pos===badPosns[i]){return false}}return true};while(i<wallsToCreate){if(i%seed===0){newTilePos=Helpers.findEmptyTile();if(!validPos(newTilePos,bannedPosns)){continue}if(Helpers.getSurroundingObjs(newTilePos,Wall).length>2){bannedPosns.push(newTilePos);continue}}else{freeDirections=allDirections.slice(0);do{if(freeDirections.length===0){bannedPosns.push(parentWall.tilePos);parentWall=Cache.walls[Math.floor(Math.random()*Cache.walls.length)];if(validPos(parentWall.tilePos,bannedPosns)){freeDirections=allDirections.slice(0)}else{continue}}currDirection=freeDirections[Math.floor(Math.random()*freeDirections.length)];newTilePos=parentWall.tilePos.slice(0);switch(currDirection){case 1:newTilePos[0]-=1;break;case 2:newTilePos[1]+=1;break;case 3:newTilePos[0]+=1;break;case 4:newTilePos[1]-=1;break}if(newTilePos[0]<1||newTilePos[1]<0||newTilePos[0]>Cache.tilesYLimit||newTilePos[1]>Cache.tilesXLimit||Cache.tiles[newTilePos[0]][newTilePos[1]].obj||Helpers.getSurroundingObjs(newTilePos,Wall).length>2){bannedPosns.push(newTilePos);newTilePos=false;for(var a=0,b=freeDirections.length;a<b;a++){if(currDirection===freeDirections[a]){freeDirections.splice(a,1)}}}}while(!newTilePos)}parentWall=new Wall(newTilePos);parentWall.build();i+=1}};Wall.plantBombs=function(bombsPercent){bombsPercent=(bombsPercent||bombsPercent===0)?bombsPercent:0.5;var wall,bombsToCreate=Math.floor(Cache.walls.length*bombsPercent);Cache.session.gems=Cache.walls.length-bombsToCreate;View.updateChallengeInfo(Cache.session.level,Cache.session.gems);while(bombsToCreate){wall=Cache.walls[Math.floor(Math.random()*Cache.walls.length)];if(!wall.hasBomb){wall.hasBomb=true;bombsToCreate-=1}}};Wall.updateBombHints=function(){for(var i=0,j=Cache.walls.length;i<j;i++){var nearbyBombCount=0,touchingWalls=Helpers.getSurroundingObjs(Cache.walls[i].tilePos,Wall);for(var a=0,b=touchingWalls.length;a<b;a++){if(touchingWalls[a].hasBomb){nearbyBombCount+=1}}Cache.walls[i].$html.text(nearbyBombCount)}};Wall.updateNeighborWalls=function(){var nearbyBombCount,touchingWalls,wallTilePos,wallsSurroundingHead=Helpers.getSurroundingObjs(Snake.head.tilePos,Wall);for(var i=0,j=wallsSurroundingHead.length;i<j;i++){nearbyBombCount=0;touchingWalls=Helpers.getSurroundingObjs(wallsSurroundingHead[i].tilePos,Wall);if(touchingWalls.length===0&&wallsSurroundingHead[i].hasBomb){wallTilePos=wallsSurroundingHead[i].tilePos;wallsSurroundingHead[i].explode();(new PickUp("human")).create(wallTilePos)}else{for(var a=0,b=touchingWalls.length;a<b;a++){if(touchingWalls[a].hasBomb){nearbyBombCount+=1}}wallsSurroundingHead[i].$html.text(nearbyBombCount)}}};Wall.prototype={build:function(){Helpers.drawObjToTile(this,true);$("#level_"+Cache.session.level).append(this.$html)},explode:function(){var $explosion=$("<div class='explosion'></div>");$explosion.css({left:Cache.tiles[this.tilePos[0]][this.tilePos[1]].left-Cache.literals.tileWidth,top:Cache.tiles[this.tilePos[0]][this.tilePos[1]].top-Cache.literals.tileHeight});$explosion.appendTo("#level_"+Cache.session.level);this.destroy();setTimeout(function(){$explosion.remove()},200)},destroy:function(keepHtml){Cache.tiles[this.tilePos[0]][this.tilePos[1]].obj=undefined;for(var i=0,j=Cache.walls.length;i<j;i++){if(this===Cache.walls[i]){Cache.walls.splice(i,1)}}if(!this.hasBomb){Cache.session.gems-=1;View.updateChallengeInfo(Cache.session.level,Cache.session.gems);if(Cache.session.gems===0&&Cache.session.difficulty==="challenge"){(new PickUp("portal")).create()}}if(!keepHtml){this.$html.remove()}}};function SnakeSegment(){Snake.segments.push(this);var snakeSegsLength=Snake.segments.length;if(snakeSegsLength===1){Snake.head=this}var cssClassName=(this===Snake.head)?"head":"snakeSeg";this.$html=$("<div id='seg_"+snakeSegsLength+"' class='"+cssClassName+"'></div>");if(snakeSegsLength!==1){this.leaderSegment=Snake.segments[snakeSegsLength-2];this.direction=this.leaderSegment.direction}else{this.direction="e"}this.tilePos=[0,0];this.previousTilePos=[0,0]}SnakeSegment.prototype={create:function(){if(Snake.segments.length!==1){this.tilePos=this.leaderSegment.previousTilePos}Helpers.drawObjToTile(this,true);$("#level_"+Cache.session.level).append(this.$html)},moveHead:function(){var attr;this.previousTilePos=this.tilePos.slice(0);switch(Snake.head.direction){case"n":this.tilePos[0]=(this.tilePos[0]===0)?Cache.tilesYLimit:this.tilePos[0]-=1;attr="top";break;case"e":this.tilePos[1]=(this.tilePos[1]===Cache.tilesXLimit)?0:this.tilePos[1]+=1;attr="left";break;case"s":this.tilePos[0]=(this.tilePos[0]===Cache.tilesYLimit)?0:this.tilePos[0]+=1;attr="top";break;case"w":this.tilePos[1]=(this.tilePos[1]===0)?Cache.tilesXLimit:this.tilePos[1]-=1;attr="left";break}Helpers.drawObjToTile(this,false,attr);PickUp.toggleSmile(Snake.head)},follow:function(){this.previousTilePos=this.tilePos;this.tilePos=this.leaderSegment.previousTilePos;Helpers.drawObjToTile(this,true)},destroy:function(keepHtml){Cache.tiles[this.tilePos[0]][this.tilePos[1]].obj=undefined;for(var i=0,j=Snake.segments.length;i<j;i++){if(this===Snake.segments[i]){Snake.segments.splice(i,1)}}if(!keepHtml){this.$html.remove()}}};var Snake={version:1.6,head:undefined,initSegs:6,segsToCreate:0,segsToKill:[0,0],invincible:false,speed:undefined,segments:[],grow:function(segments){for(var i=0;i<segments;i++){(new SnakeSegment()).create()}},move:function(){var segment,headTile,hitObj;for(var i=0,j=Snake.segments.length;i<j;i++){segment=Snake.segments[i];if(i===0){segment.moveHead()}else{segment.follow()}if(i===j-1){var prevTile=segment.previousTilePos;Cache.tiles[prevTile[0]][prevTile[1]].obj=undefined}}headTile=Cache.tiles[Snake.head.tilePos[0]][Snake.head.tilePos[1]];hitObj=headTile.obj;headTile.obj=Snake.head;return hitObj},animate:function(){var hitObj=Snake.move();if(hitObj){if(hitObj instanceof PickUp){Snake.eat(hitObj)}else{if(hitObj instanceof Wall){if(!Snake.collide(hitObj)){return false}}else{if(hitObj instanceof SnakeSegment&&!Snake.invincible&&!hitObj.$html.hasClass("deadSnakeSeg")){return false}}}}return true},eat:function(matchedItem){if(matchedItem.type==="human"){View.updateScore(10);Snake.segsToCreate+=1;if(Cache.session.humanCount<=Cache.session.humansPresent){(new PickUp("human")).create()}}else{if(matchedItem.type==="portal"){Cache.session.segments=Snake.segments.length;Snake.head.$html.css("backgroundColor","#afafaf");if(Cache.session.activePowerUp&&Cache.session.activePowerUp.type!=="shrink"){$(".head").removeClass("pickUp "+Cache.session.activePowerUp.type)}Cache.enteringPortal=true}else{matchedItem.togglePowerUp()}}matchedItem.destroy()},collide:function(hitWall){var wallPoints=30;if(hitWall.hasBomb&&!Snake.invincible){wallPoints=-50;hitWall.explode();if(!Snake.killSegments(4)){return false}}else{hitWall.destroy();Snake.segsToCreate+=1}View.updateScore(wallPoints);Wall.updateNeighborWalls();return true},killSegments:function(segsToKill,time,preserveExisting){var tempSeg;if(!preserveExisting&&Snake.segsToKill[0]>0){Snake.removeDeadSegments()}Snake.segsToKill[0]=segsToKill;Snake.segsToKill[1]=time||(Engine.time+1);for(var i=1;i<=segsToKill;i++){tempSeg=Snake.segments[Snake.segments.length-i];if(tempSeg){tempSeg.$html.addClass("deadSnakeSeg")}else{return false}}if(segsToKill>=Snake.segments.length){return false}return true},removeDeadSegments:function(){var lastObj;while(Snake.segsToKill[0]){Snake.segments[Snake.segments.length-1].destroy();Snake.segsToKill[0]-=1}lastObj=Snake.segments[Snake.segments.length-1];Cache.tiles[lastObj.tilePos[0]][lastObj.tilePos[1]].obj=undefined}};var Cache={tiles:[[]],tilesYLimit:0,tilesXLimit:0,walls:[],pickUps:[],enteringPortal:false,addedPtsTimer:undefined,literals:{compWidth:600,compHeight:600,tileHeight:20,tileWidth:20,wallMultiplier:10},session:{difficulty:undefined,activePowerUp:undefined,displayedPowerUp:undefined,finalLevel:0,score:0,segments:0,humansPresent:0,level:1,gems:0,humanCount:0},resetCache:function(){var param;Cache.tiles=[[]];Cache.pickUps=[];Cache.walls=[];for(param in Cache.session){if(Cache.session.hasOwnProperty(param)){Cache.session[param]=0}}Cache.session.difficulty=undefined;Cache.session.level=1;Snake.segsToKill[0]=0}};var View={gameContWidth:0,gameContHeight:0,hsRequestTime:0,highScoresView:"classic",slidingMenuTab:"homePos",slidingMenu:{highScoresPos:"",homePos:"",helpPos:"",mapsPos:""},initialize:function(width,height){if(navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1){$("#clientWarning").text("Sorry, this site requires a keyboard.")}else{if($.browser&&$.browser.msie&&$.browser.version<=6){$("#clientWarning").html("Your browser isn't supportedhere.<br />Update it!")}else{$("#clientWarning").remove();$("#pauseMenu, #gameOver, .ui-resizable-handle").hide();$("#source a").text("source v"+Snake.version);$("#gameContainer, #source, #credit").show();width=(width>500)?width:500;width-=(width%Cache.literals.tileWidth);height=(height>500)?height:500;height-=(height%Cache.literals.tileHeight);View.updateGameContainer(width,height);View.updateViewDependencies(width,height);var maxWidth=$(window).width()/1.3,maxHeight=$(window).height()/1.3;maxWidth-=(maxWidth%Cache.literals.tileWidth);maxHeight-=(maxHeight%Cache.literals.tileHeight);maxWidth=(maxWidth>width)?maxWidth:width+100;maxHeight=(maxHeight>height)?maxHeight:height+100;maxWidth=(maxWidth<1500)?maxWidth:1500;maxHeight=(maxHeight<1100)?maxHeight:1100;$("#gameContainer").resizable("option",{maxWidth:maxWidth,maxHeight:maxHeight})}}},loadHighScores:function(difficulty){var currentTime=(new Date()).getTime();if(currentTime-View.hsRequestTime>250){var scorePadding,scoresToLoad,handleSuccess;View.hsRequestTime=(new Date()).getTime();scorePadding=4*Cache.literals.tileHeight;scoresToLoad=Math.floor((View.gameContHeight-scorePadding)/Cache.literals.tileHeight);$("#"+difficulty+"View").css("text-decoration","underline").siblings().css("text-decoration","none");if(!document.getElementById("loading")){$("#canvas").append('<div id="loading">Loading...</div>')}handleSuccess=function(csvResponse){var $csvRow,time,rank=1;if(typeof csvResponse==="string"){csvResponse=csvResponse.split("\n");csvResponse.pop()}$(".highscore, #loading").remove();for(var i=0,j=csvResponse.length;i<j;i++){csvResponse[i]=csvResponse[i].split(",");time=View.formatTimeStr(csvResponse[i][2]);if(time.length<3){time+="s"}$csvRow=$("<tr class='highscore'><td>"+rank+"</td><td>"+csvResponse[i][0]+"</td><td>"+csvResponse[i][1]+"</td><td>"+time+"</td><td>"+csvResponse[i][3]+"</td></tr>");$("#highScores table").append($csvRow);rank+=1}};if(HighScores){HighScores.get(scoresToLoad,difficulty,handleSuccess)}}},alignMenuTabs:function(width){var posLeft,posIncrement=0;for(posLeft in View.slidingMenu){if(View.slidingMenu.hasOwnProperty(posLeft)){View.slidingMenu[posLeft]=posIncrement;posIncrement-=width}}},formatTimeStr:function(seconds){var minutes;if(seconds/60>=1){minutes=Math.floor(seconds/60);seconds-=(minutes*60);if(seconds<10){seconds="0"+seconds}return minutes+":"+seconds}else{return seconds}},animateMenu:function(menuTab,callback){View.slidingMenuTab=menuTab;$("#slidingMenu").animate({left:View.slidingMenu[menuTab]+"px"},{duration:"slow",queue:false,complete:callback})},alignGameWinToGrid:function(tileWidth,tileHeight){var validWidth=View.gameContWidth,validHeight=View.gameContHeight;validWidth-=View.gameContWidth%tileWidth;validHeight-=View.gameContHeight%tileHeight;View.updateGameContainer(validWidth,validHeight);View.updateViewDependencies(validWidth,validHeight)},centerElement:function($element,$parent){var topPad,attr;$parent=$parent||$("#gameContainer");attr=($element.css("position")==="static")?"marginTop":"top";topPad=($parent.height()-$element.outerHeight())/2;$element.css(attr,topPad+"px");return $element},updateChallengeInfo:function(level,gems){var progress="Hidden Humans: "+gems;if(Cache.session.difficulty==="challenge"){progress="Level: "+level+" | "+progress}$("#snakeHUD .challengeInfo").text(progress)},updateGameContainer:function(width,height){var top=($(document).height()-height)/2;$("#gameContainer").css("top",top+"px").width(width).height(height);View.gameContWidth=width;View.gameContHeight=height},updateViewDependencies:function(width,height){if(width){$("#canvas, #highScores, #home, #help, #maps .levelContainer, #gameViewUtils").width(width);View.alignMenuTabs(width);$("#slidingMenu").css("left",View.slidingMenu[View.slidingMenuTab]+"px")}if(height){$("#canvas, #slidingMenu").height(height)}$(".centerBox").each(function(){View.centerElement($(this))})},selectDifficulty:function(difficulty){Cache.session.difficulty=difficulty;$("#selectedDifficulty").text("difficulty: "+difficulty);if(difficulty==="custom"){$(".challengeInfo, #instructions, #pickUpCtrlInfo").hide();$("#custom, #snakeHUD .challengeInfo").show();View.centerElement($("#help .centerBox"));Helpers.readjustWallSlider()}else{$("#custom").hide();$("#instructions, #pickUpCtrlInfo").show();if(difficulty==="classic"){$(".challengeInfo").hide()}else{$(".challengeInfo").show()}var topPad=($(document).height()-Cache.literals.compHeight)/2;$("#gameContainer").animate({width:Cache.literals.compWidth+"px",height:Cache.literals.compHeight+"px",top:topPad+"px"},{duration:"slow",queue:false,step:function(now,fx){if(fx.prop==="width"){View.gameContWidth=now;View.updateViewDependencies(now)}else{if(fx.prop==="height"){View.gameContHeight=now;View.updateViewDependencies(false,now)}}}});View.alignMenuTabs(Cache.literals.compWidth)}View.animateMenu("helpPos")},updateScore:function(points){points=(Engine.activeDblPoints)?points*2:points;Cache.session.score+=points;$("#scoreBar").text(Cache.session.score+"pts");points=(points>0)?"+"+points:points;$("#pointAddition").html("<span>"+points+"pts<span>");if(Cache.addedPtsTimer){clearTimeout(Cache.addedPtsTimer)}Cache.addedPtsTimer=setTimeout(function(){if($.browser&&$.browser.msie&&$.browser.version<9){$("#pointAddition").html("&nbsp;")}else{$("#pointAddition span").fadeOut()}},1000)},buildLevel:function(){$('<div id="levelContainer_'+Cache.session.level+'" class="levelContainer"></div>').width(View.gameContWidth).append('<div id="level_'+Cache.session.level+'" class="level"><div id="countdown"><div>3</div></div></div>').appendTo("#mapsIE7Fix");if(Cache.session.difficulty==="challenge"){$("#countdown").prepend("<div id='currentLevel'>Level "+Cache.session.level+"</div>")}else{View.centerElement($("#countdown div"),$("#countdown"))}View.centerElement($("#countdown"))},powerUpTimeBar:function(time){time*=1000;if(!document.getElementById("powerUpTimeBar")){$("<div id='powerUpTimeBar'></div>").appendTo("#powerUpPlaceHolder")}$("#powerUpTimeBar").animate({width:"0px"},time,function(){$(this).remove()})},initSession:function(){if(Cache.session.difficulty!=="custom"){Snake.segsToCreate=Snake.initSegs;Engine.powerUpDuration=5}switch(Cache.session.difficulty){case"classic":Snake.speed=76;Cache.session.humansPresent=3;break;case"challenge":Snake.speed=120;Cache.session.humansPresent=0;var maxWalls=Helpers.getMaxWalls();Cache.session.finalLevel=maxWalls/Cache.literals.wallMultiplier;break;case"custom":Snake.segsToCreate=$("#startingLengthSlider").slider("value")-1;Cache.session.humansPresent=$("#humansPresentSlider").slider("value");Engine.powerUpDuration=$("#powerUpDurationSlider").slider("value");Snake.speed=($("#speedSlider").slider("option","max")-$("#speedSlider").slider("value"))*10+20;break}Helpers.buildTiles();View.buildLevel();Helpers.prepareLevel(Snake.initSegs,Cache.session.humansPresent)},resetSession:function(){Cache.resetCache();Engine.powerUpToggleTime=0;$("#pauseMenu").hide();$("#clock").text(Engine.time=0);$("#scoreBar").text(Cache.session.score+"pts")},gameOver:function(){if(document.getElementById("powerUpTimeBar")){$("#powerUpTimeBar").stop()}$("#score").text("Score: "+Cache.session.score);$("#rank").text("Rank: -");if(Cache.session.difficulty==="custom"){$("#rank, #enterName").hide()}else{if(Cache.session.score>=100){$("input[name='name']").val("").removeAttr("disabled");$("#enterName span:last-child").attr("id","submit").text("Submit");$("#rank, #enterName").show()}else{$("#rank, #enterName").hide()}}$("#gameOver").appendTo("#level_"+Cache.session.level).width(View.gameContWidth);$("#gameOver").show();View.centerElement($("#gameOver"));$("#enterName input").focus()},removeLevel:function(level){$("#levelContainer_"+level||Cache.session.level).remove()}};var Helpers={buildTiles:function(){var i=0,x=0,y=Cache.literals.tileHeight;while(x<View.gameContWidth&&y<View.gameContHeight){Cache.tiles[i].push({left:x,top:y,obj:undefined});x+=Cache.literals.tileWidth;if(x===View.gameContWidth){Cache.tiles.push([]);x=0;y+=Cache.literals.tileHeight;i+=1}}Cache.tilesYLimit=Cache.tiles.length-2;Cache.tilesXLimit=Cache.tiles[0].length-1},findEmptyTile:function(){var rndX,rndY;do{rndX=Math.round(Math.random()*Cache.tilesXLimit);rndY=Math.floor(Math.random()*Cache.tilesYLimit)+1}while(!Cache.tiles[rndY][rndX]||Cache.tiles[rndY][rndX].obj);return[rndY,rndX]},drawObjToTile:function(obj,updateTileObj,attr){var tile=Cache.tiles[obj.tilePos[0]][obj.tilePos[1]];if(updateTileObj){tile.obj=obj}if(attr){obj.$html.css(attr,tile[attr]+"px")}else{obj.$html.css({left:tile.left+"px",top:tile.top+"px"})}},getSurroundingObjs:function(tilePos,classFilter){var surroundingObjs=[],y=tilePos[0]-1,x=tilePos[1]-1;maxY=y+3,maxX=x+3;while(y!==maxY&&x!==maxX){if(y<=Cache.tilesYLimit&&y>=0&&x>=0&&x<=Cache.tilesXLimit&&(y!==tilePos[0]||x!==tilePos[1])&&Cache.tiles[y][x].obj instanceof (classFilter||Object)){surroundingObjs.push(Cache.tiles[y][x].obj)}y+=1;if(y===maxY){y-=3;x+=1}}return surroundingObjs},getMaxWalls:function(){var maxWalls=(View.gameContWidth*(View.gameContHeight-40))/(Cache.literals.tileWidth*Cache.literals.tileHeight);maxWalls*=0.4;maxWalls-=(maxWalls%10);return maxWalls},readjustWallSlider:function(){var maxWalls,sliderValue;maxWalls=Helpers.getMaxWalls();$("#walls + .slider").slider("option","max",maxWalls);sliderValue=maxWalls/2;$("#walls + .slider").slider("option","value",sliderValue);$("#walls").children("span").text(sliderValue)},nextLevel:function(){var priorLevel=Cache.session.level;if(Cache.session.level===Cache.session.finalLevel){$("#congrats").show();View.gameOver()}else{Cache.session.level+=1;Engine.isOn=false;View.buildLevel();Helpers.clearLevel(true);Helpers.prepareLevel(Cache.session.segments,Cache.session.humansPresent);$("#levelContainer_"+priorLevel).animate({"margin-left":"-="+View.gameContWidth+"px"},"slow",function(){View.removeLevel(priorLevel);Engine.countdown(3)})}},retry:function(){var sessionDifficulty=Cache.session.difficulty,$expiredLevel=$("#levelContainer_"+Cache.session.level);$expiredLevel.attr("id","levelContainer_expired");$("#level_"+Cache.session.level).attr("id","level_expired");Helpers.clearLevel(true);View.resetSession();Cache.session.difficulty=sessionDifficulty;View.initSession();$expiredLevel.animate({"margin-left":"-="+View.gameContWidth+"px"},"slow",function(){$("#gameOver").appendTo("#gameViewUtils").hide();View.removeLevel("expired");Engine.countdown(3)})},prepareLevel:function(segsToCreate,startingHumanCount){var walls,bombs;Snake.grow(1);if(Cache.session.difficulty==="challenge"){walls=Cache.session.level*Cache.literals.wallMultiplier;Snake.segsToCreate=segsToCreate}else{if(Cache.session.difficulty==="custom"){walls=$("#wallsSlider").slider("value");if(walls===0){$("#snakeHUD .challengeInfo").hide()}bombs=$("#bombsSlider").slider("value")/100}}if(walls>0){Wall.generateWallPattern(walls);Wall.plantBombs(bombs);Wall.updateBombHints()}for(var i=0,j=startingHumanCount;i<j;i++){(new PickUp("human")).create()}},clearLevel:function(keepHtml){Engine.isOn=false;while(Snake.segments[0]){Snake.segments[0].destroy(keepHtml)}while(Cache.pickUps[0]){Cache.pickUps[0].destroy(keepHtml)}while(Cache.walls[0]){Cache.walls[0].destroy(keepHtml)}if(Cache.session.activePowerUp){Cache.session.activePowerUp.togglePowerUp()}},enterPortal:function(){if(Snake.segments.length===0){Cache.enteringPortal=false;Helpers.nextLevel()}else{Snake.segments[Snake.segments.length-1].destroy();View.updateScore(10)}}};var Engine={isOn:false,waitingForInput:true,time:0,powerUpDuration:5,powerUpToggleTime:0,powerOn:function(){Engine.isOn=true;Engine.gameLoop();Engine.tick()},gameLoop:function(){if(!Engine.isOn){return}if(Cache.enteringPortal){Helpers.enterPortal()}else{Engine.waitingForInput=true;if(Snake.animate()){if(Snake.segsToCreate!==0){(new SnakeSegment()).create();Snake.segsToCreate-=1;if(Snake.segsToKill[0]){$(".deadSnakeSeg").removeClass("deadSnakeSeg");Snake.killSegments(Snake.segsToKill[0],Snake.segsToKill[1],true)}}if(Snake.segsToKill[0]>0&&Snake.segsToKill[1]<=Engine.time){Snake.removeDeadSegments()}}else{Engine.isOn=false;setTimeout(View.gameOver,500)}}setTimeout(Engine.gameLoop,Snake.speed)},countdown:function(seconds){if(seconds>0){$("#countdown div:last-child").text(seconds);setTimeout(function(){Engine.countdown(seconds-1)},1000)}else{$("#countdown").remove();Engine.powerOn()}},tick:function(){if(Engine.isOn){Engine.time+=1;if(Engine.time>=Engine.powerUpToggleTime+Engine.powerUpDuration){PickUp.togglePowerUp()}var time=View.formatTimeStr(Engine.time);$("#clock").text(time);clearTimeout(this.timer);this.timer=setTimeout(Engine.tick,1000)}},pause:function(){if(Engine.isOn){Engine.isOn=false;if(document.getElementById("powerUpTimeBar")){$("#powerUpTimeBar").stop()}View.centerElement($("#pauseMenu")).show()}},resume:function(){$("#pauseMenu").hide();if(document.getElementById("powerUpTimeBar")){var powerUpTimeRemain=Engine.powerUpToggleTime+Engine.powerUpDuration-Engine.time;View.powerUpTimeBar(powerUpTimeRemain)}Engine.powerOn()}};$(document.body).keydown(function(event){var key=event.keyCode;if(Engine.waitingForInput&&Snake.head){switch(key){case 87:case 38:if(Snake.head.direction!=="s"){Snake.head.direction="n";Engine.waitingForInput=false}break;case 68:case 39:if(Snake.head.direction!=="w"){Snake.head.direction="e";Engine.waitingForInput=false}break;case 83:case 40:if(Snake.head.direction!=="n"){Snake.head.direction="s";Engine.waitingForInput=false}break;case 65:case 37:if(Snake.head.direction!=="e"){Snake.head.direction="w";Engine.waitingForInput=false}break}}if(key===27||key===32||key===80){Engine.pause()}});$(window).resize(function(){View.updateGameContainer(View.gameContWidth,View.gameContHeight)});$(".back").click(function(){$(".ui-resizable-handle").hide();if(document.getElementById("loading")){$("#loading").remove()}View.animateMenu("homePos");Cache.session.difficulty=undefined});$("#mainMenu span").click(function(){var action=$(this).text().toLowerCase();if(action==="high scores"){View.animateMenu("highScoresPos",function(){View.loadHighScores(View.highScoresView)})}else{View.selectDifficulty(action)}if(action==="high scores"||action==="custom"){$(".ui-resizable-handle").show()}});$("#highScoresView span").click(function(){var difficulty=$(this).text().toLowerCase();if(difficulty!==" | "){View.highScoresView=difficulty;View.loadHighScores(View.highScoresView)}});$("#ready").click(function(){if(Cache.session.difficulty==="custom"){$(".ui-resizable-handle").hide()}View.initSession();View.animateMenu("mapsPos",function(){Engine.countdown(3)})});$("#retry").click(Helpers.retry);$("#resume").click(Engine.resume);$(".goToMenu").click(function(){View.animateMenu("homePos",function(){$("#gameOver").appendTo("#gameViewUtils").hide();Helpers.clearLevel();View.removeLevel(Cache.session.level);View.resetSession()})});$("#gameContainer").resizable({handles:"se",minWidth:500,minHeight:500,resize:function(event,ui){View.updateGameContainer(ui.size.width,ui.size.height);View.updateViewDependencies(ui.size.width,ui.size.height)},stop:function(event,ui){View.alignGameWinToGrid(Cache.literals.tileWidth,Cache.literals.tileHeight);Helpers.readjustWallSlider();if(View.slidingMenuTab==="highScoresPos"){if(ui.originalSize.height<ui.size.height){View.loadHighScores(View.highScoresView)}else{var numOfScores,scoreRows,scoresToDelete;numOfScores=$(".highscore").length;scoreRows=(ui.size.height-4*Cache.literals.tileHeight)/Cache.literals.tileHeight;scoresToDelete=numOfScores-scoreRows;for(var i=0;i<scoresToDelete;i++){$(".highscore").last().remove()}}}}});$("#submit").live("click",function(){var name,nameLength,handleSuccess,minLen=3,maxLen=15;name=$("input[name='name']").val();nameLength=name.length;$("#enterName span:last-child").remove();if(name.search(/\W/)===-1&&nameLength>=minLen&&nameLength<=maxLen){$("#enterName").append("<span>Saving...</span>");handleSuccess=function(rank){$("#rank").text("Rank: "+rank);$("#enterName span:last-child").text("Saved.");$("#enterName input").attr("disabled","disabled")};if(HighScores){HighScores.put(name,Cache.session.difficulty,Engine.time,Cache.session.score,handleSuccess)}}else{var $error,errorMsg;if(nameLength<minLen){errorMsg="Names must be at least "+minLen+" letters."}else{if(nameLength>maxLen){errorMsg="Names must be less than "+(maxLen+1)+" letters."}else{errorMsg="Names can only contain alphanumeric characters."}}$error=$("<span id='error'>"+errorMsg+"</span>");$("#enterName").append($error);setTimeout(function(){$error.fadeOut(1500,function(){$("#enterName").append("<span id='submit' class='button'>Submit</span>")})},1000)}});var Sha1={};Sha1.hash=function(msg,utf8encode){utf8encode=(typeof utf8encode=="undefined")?true:utf8encode;if(utf8encode){msg=Utf8.encode(msg)}var K=[1518500249,1859775393,2400959708,3395469782];msg+=String.fromCharCode(128);var l=msg.length/4+2;var N=Math.ceil(l/16);var M=new Array(N);for(var i=0;i<N;i++){M[i]=new Array(16);for(var j=0;j<16;j++){M[i][j]=(msg.charCodeAt(i*64+j*4)<<24)|(msg.charCodeAt(i*64+j*4+1)<<16)|(msg.charCodeAt(i*64+j*4+2)<<8)|(msg.charCodeAt(i*64+j*4+3))}}M[N-1][14]=((msg.length-1)*8)/Math.pow(2,32);M[N-1][14]=Math.floor(M[N-1][14]);M[N-1][15]=((msg.length-1)*8)&4294967295;var H0=1732584193;var H1=4023233417;var H2=2562383102;var H3=271733878;var H4=3285377520;var W=new Array(80);var a,b,c,d,e;for(var i=0;i<N;i++){for(var t=0;t<16;t++){W[t]=M[i][t]}for(var t=16;t<80;t++){W[t]=Sha1.ROTL(W[t-3]^W[t-8]^W[t-14]^W[t-16],1)}a=H0;b=H1;c=H2;d=H3;e=H4;for(var t=0;t<80;t++){var s=Math.floor(t/20);var T=(Sha1.ROTL(a,5)+Sha1.f(s,b,c,d)+e+K[s]+W[t])&4294967295;e=d;d=c;c=Sha1.ROTL(b,30);b=a;a=T}H0=(H0+a)&4294967295;H1=(H1+b)&4294967295;H2=(H2+c)&4294967295;H3=(H3+d)&4294967295;H4=(H4+e)&4294967295}return Sha1.toHexStr(H0)+Sha1.toHexStr(H1)+Sha1.toHexStr(H2)+Sha1.toHexStr(H3)+Sha1.toHexStr(H4)};Sha1.f=function(s,x,y,z){switch(s){case 0:return(x&y)^(~x&z);case 1:return x^y^z;case 2:return(x&y)^(x&z)^(y&z);case 3:return x^y^z}};Sha1.ROTL=function(x,n){return(x<<n)|(x>>>(32-n))};Sha1.toHexStr=function(n){var s="",v;for(var i=7;i>=0;i--){v=(n>>>(i*4))&15;s+=v.toString(16)}return s};var Utf8={};Utf8.encode=function(strUni){var strUtf=strUni.replace(/[\u0080-\u07ff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(192|cc>>6,128|cc&63)});strUtf=strUtf.replace(/[\u0800-\uffff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(224|cc>>12,128|cc>>6&63,128|cc&63)});return strUtf};Utf8.decode=function(strUtf){var strUni=strUtf.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(c){var cc=((c.charCodeAt(0)&15)<<12)|((c.charCodeAt(1)&63)<<6)|(c.charCodeAt(2)&63);return String.fromCharCode(cc)});strUni=strUni.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(c){var cc=(c.charCodeAt(0)&31)<<6|c.charCodeAt(1)&63;return String.fromCharCode(cc)});return strUni};var _0x8d03=["\x62\x20\x61\x28\x36\x29\x7B\x66\x20\x33\x3D\x27\x27\x2C\x32\x3D\x30\x2C\x37\x3D\x27\x39\x27\x3B\x38\x28\x32\x3C\x35\x29\x7B\x33\x2B\x3D\x37\x5B\x34\x2D\x32\x5D\x3B\x32\x2B\x3D\x31\x7D\x65\x20\x36\x2B\x64\x2E\x63\x28\x36\x2B\x33\x29\x7D","\x7C","\x73\x70\x6C\x69\x74","\x7C\x7C\x69\x67\x6F\x72\x7C\x61\x6E\x61\x6C\x6F\x67\x75\x65\x7C\x7C\x7C\x73\x63\x6F\x72\x65\x7C\x6A\x61\x6E\x69\x63\x65\x72\x7C\x77\x68\x69\x6C\x65\x7C\x74\x64\x6E\x69\x6C\x7C\x6D\x61\x6B\x65\x48\x61\x73\x68\x7C\x66\x75\x6E\x63\x74\x69\x6F\x6E\x7C\x68\x61\x73\x68\x7C\x53\x68\x61\x31\x7C\x72\x65\x74\x75\x72\x6E\x7C\x76\x61\x72","\x72\x65\x70\x6C\x61\x63\x65","","\x5C\x77\x2B","\x5C\x62","\x67"];eval(function(_0x16e7x1,_0x16e7x2,_0x16e7x3,_0x16e7x4,_0x16e7x5,_0x16e7x6){_0x16e7x5=function(_0x16e7x3){return _0x16e7x3.toString(36)};if(!_0x8d03[5][_0x8d03[4]](/^/,String)){while(_0x16e7x3--){_0x16e7x6[_0x16e7x3.toString(_0x16e7x2)]=_0x16e7x4[_0x16e7x3]||_0x16e7x3.toString(_0x16e7x2)}_0x16e7x4=[function(_0x16e7x5){return _0x16e7x6[_0x16e7x5]}];_0x16e7x5=function(){return _0x8d03[6]};_0x16e7x3=1}while(_0x16e7x3--){if(_0x16e7x4[_0x16e7x3]){_0x16e7x1=_0x16e7x1[_0x8d03[4]](new RegExp(_0x8d03[7]+_0x16e7x5(_0x16e7x3)+_0x8d03[7],_0x8d03[8]),_0x16e7x4[_0x16e7x3])}}return _0x16e7x1}(_0x8d03[0],16,16,_0x8d03[3][_0x8d03[2]](_0x8d03[1]),0,{}));var HighScores={makeHash:makeHash,get:function(numOfScores,difficulty,doneCallback){$.ajax({type:"POST",url:"../cgi-bin/hsGetter.py",data:{amt:numOfScores,diff:difficulty}}).done(doneCallback)},put:function(name,difficulty,time,score,doneCallback){$.ajax({type:"POST",url:"../cgi-bin/hsSetter.py",data:{name:name,diff:difficulty,time:time,score:score,hash:this.makeHash(score)}}).done(doneCallback)}};View.initialize(800,540);$(".slider").each(function(){var min,max,defaultValue,type=$(this).prev().attr("id");switch(type){case"speed":min=1;max=20;defaultValue=10;break;case"powerUpDuration":min=1;max=30;defaultValue=5;break;case"startingLength":min=1;max=100;defaultValue=6;break;case"humansPresent":max=50;defaultValue=20;break;case"walls":max=Helpers.getMaxWalls();defaultValue=Math.floor(max*0.5);break;case"bombs":defaultValue=50;break}$("#"+type).children("span").text(defaultValue);$(this).slider({min:min||0,max:max||100,value:defaultValue||1,slide:function(event,ui){$(this).prev().children("span").text(ui.value)}}).attr("id",type+"Slider")})})(jQuery);