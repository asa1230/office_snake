function PickUp(a){Cache.pickUps.push(this),this.type=a,"human"===a?(this.type="human",Cache.session.humanCount+=1):"powerUp"===a?(this.type=PickUp.generateType(),this.type="invincible"===this.type?PickUp.generateType():this.type,Cache.session.displayedPowerUp=this):"portal"===a&&(this.type="portal"),this.$html=$("<div class='pickUp "+this.type+"'></div>"),this.tilePos=[0,0]}function SnakeSegment(){Snake.segments.push(this);var a=Snake.segments.length;1===a&&(Snake.head=this);var b=this===Snake.head?"head":"snakeSeg";this.$html=$("<div id='seg_"+a+"' class='"+b+"'></div>"),1!==a?(this.leaderSegment=Snake.segments[a-2],this.direction=this.leaderSegment.direction):this.direction="e",this.tilePos=[0,0],this.previousTilePos=[0,0]}function Wall(a){Cache.walls.push(this),this.$html=$("<div class='wall'></div>"),this.tilePos=a,this.hasBomb=!1,this.direction=void 0}var Cache={tiles:[[]],tilesYLimit:0,tilesXLimit:0,walls:[],pickUps:[],enteringPortal:!1,addedPtsTimer:void 0,literals:{compWidth:600,compHeight:600,tileHeight:20,tileWidth:20,wallMultiplier:10},session:{difficulty:void 0,activePowerUp:void 0,displayedPowerUp:void 0,finalLevel:0,score:0,segments:0,humansPresent:0,level:1,gems:0,humanCount:0},resetCache:function(){var a;Cache.tiles=[[]],Cache.pickUps=[],Cache.walls=[];for(a in Cache.session)Cache.session.hasOwnProperty(a)&&(Cache.session[a]=0);Cache.session.difficulty=void 0,Cache.session.level=1,Snake.segsToKill[0]=0}},Engine={isOn:!1,waitingForInput:!0,time:0,powerUpDuration:5,powerUpToggleTime:0,powerOn:function(){Engine.isOn=!0,Engine.gameLoop(),Engine.tick()},gameLoop:function(){Engine.isOn&&(Cache.enteringPortal?Helpers.enterPortal():(Engine.waitingForInput=!0,Snake.animate()?(0!==Snake.segsToCreate&&((new SnakeSegment).create(),Snake.segsToCreate-=1,Snake.segsToKill[0]&&($(".deadSnakeSeg").removeClass("deadSnakeSeg"),Snake.killSegments(Snake.segsToKill[0],Snake.segsToKill[1],!0))),Snake.segsToKill[0]>0&&Snake.segsToKill[1]<=Engine.time&&Snake.removeDeadSegments()):(Engine.isOn=!1,setTimeout(View.gameOver,500))),setTimeout(Engine.gameLoop,Snake.speed))},countdown:function(a){a>0?($("#countdown div:last-child").text(a),setTimeout(function(){Engine.countdown(a-1)},1e3)):($("#countdown").remove(),Engine.powerOn())},tick:function(){if(Engine.isOn){Engine.time+=1,Engine.time>=Engine.powerUpToggleTime+Engine.powerUpDuration&&PickUp.togglePowerUp();var a=View.formatTimeStr(Engine.time);$("#clock").text(a),clearTimeout(this.timer),this.timer=setTimeout(Engine.tick,1e3)}},pause:function(){Engine.isOn&&(Engine.isOn=!1,document.getElementById("powerUpTimeBar")&&$("#powerUpTimeBar").stop(),View.centerElement($("#pauseMenu")).show())},resume:function(){if($("#pauseMenu").hide(),document.getElementById("powerUpTimeBar")){var a=Engine.powerUpToggleTime+Engine.powerUpDuration-Engine.time;View.powerUpTimeBar(a)}Engine.powerOn()}},Helpers={buildTiles:function(){for(var a=0,b=0,c=Cache.literals.tileHeight;b<View.gameContWidth&&c<View.gameContHeight;)Cache.tiles[a].push({left:b,top:c,obj:void 0}),b+=Cache.literals.tileWidth,b===View.gameContWidth&&(Cache.tiles.push([]),b=0,c+=Cache.literals.tileHeight,a+=1);Cache.tilesYLimit=Cache.tiles.length-2,Cache.tilesXLimit=Cache.tiles[0].length-1},findEmptyTile:function(){var a,b;do a=Math.round(Math.random()*Cache.tilesXLimit),b=Math.floor(Math.random()*Cache.tilesYLimit)+1;while(!Cache.tiles[b][a]||Cache.tiles[b][a].obj);return[b,a]},drawObjToTile:function(a,b,c){var d=Cache.tiles[a.tilePos[0]][a.tilePos[1]];b&&(d.obj=a),c?a.$html.css(c,d[c]+"px"):a.$html.css({left:d.left+"px",top:d.top+"px"})},getSurroundingObjs:function(a,b){for(var c=[],d=a[0]-1,e=a[1]-1,f=d+3,g=e+3;d!==f&&e!==g;)d<=Cache.tilesYLimit&&d>=0&&e>=0&&e<=Cache.tilesXLimit&&(d!==a[0]||e!==a[1])&&Cache.tiles[d][e].obj instanceof(b||Object)&&c.push(Cache.tiles[d][e].obj),d+=1,d===f&&(d-=3,e+=1);return c},getMaxWalls:function(){var a=View.gameContWidth*(View.gameContHeight-40)/(Cache.literals.tileWidth*Cache.literals.tileHeight);return a*=.4,a-=a%10},readjustWallSlider:function(){var a,b;a=Helpers.getMaxWalls(),$("#walls + .slider").slider("option","max",a),b=a/2,$("#walls + .slider").slider("option","value",b),$("#walls").children("span").text(b)},nextLevel:function(){var a=Cache.session.level;Cache.session.level===Cache.session.finalLevel?($("#congrats").show(),View.gameOver()):(Cache.session.level+=1,Engine.isOn=!1,View.buildLevel(),Helpers.clearLevel(!0),Helpers.prepareLevel(Cache.session.segments,Cache.session.humansPresent),$("#levelContainer_"+a).animate({"margin-left":"-="+View.gameContWidth+"px"},"slow",function(){View.removeLevel(a),Engine.countdown(3)}))},retry:function(){var a=Cache.session.difficulty,b=$("#levelContainer_"+Cache.session.level);b.attr("id","levelContainer_expired"),$("#level_"+Cache.session.level).attr("id","level_expired"),Helpers.clearLevel(!0),View.resetSession(),Cache.session.difficulty=a,View.initSession(),b.animate({"margin-left":"-="+View.gameContWidth+"px"},"slow",function(){$("#gameOver").appendTo("#gameViewUtils").hide(),View.removeLevel("expired"),Engine.countdown(3)})},prepareLevel:function(a,b){var c,d;Snake.grow(1),"challenge"===Cache.session.difficulty?(c=Cache.session.level*Cache.literals.wallMultiplier,Snake.segsToCreate=a):"custom"===Cache.session.difficulty&&(c=$("#wallsSlider").slider("value"),0===c&&$("#snakeHUD .challengeInfo").hide(),d=$("#bombsSlider").slider("value")/100),c>0&&(Wall.generateWallPattern(c),Wall.plantBombs(d),Wall.updateBombHints());for(var e=0,f=b;f>e;e++)new PickUp("human").create()},clearLevel:function(a){for(Engine.isOn=!1;Snake.segments[0];)Snake.segments[0].destroy(a);for(;Cache.pickUps[0];)Cache.pickUps[0].destroy(a);for(;Cache.walls[0];)Cache.walls[0].destroy(a);Cache.session.activePowerUp&&Cache.session.activePowerUp.togglePowerUp()},enterPortal:function(){0===Snake.segments.length?(Cache.enteringPortal=!1,Helpers.nextLevel()):(Snake.segments[Snake.segments.length-1].destroy(),View.updateScore(10))}};$(function(){$(".slider").each(function(){var a,b,c,d=$(this).prev().attr("id");switch(d){case"speed":a=1,b=20,c=10;break;case"powerUpDuration":a=1,b=30,c=5;break;case"startingLength":a=1,b=100,c=6;break;case"humansPresent":b=50,c=20;break;case"walls":b=Helpers.getMaxWalls(),c=Math.floor(.5*b);break;case"bombs":c=50}$("#"+d).children("span").text(c),$(this).slider({min:a||0,max:b||100,value:c||1,slide:function(a,b){$(this).prev().children("span").text(b.value)}}).attr("id",d+"Slider")}),$(document.body).keydown(function(a){var b=a.keyCode;if(Engine.waitingForInput&&Snake.head)switch(b){case 87:case 38:"s"!==Snake.head.direction&&(Snake.head.direction="n",Engine.waitingForInput=!1);break;case 68:case 39:"w"!==Snake.head.direction&&(Snake.head.direction="e",Engine.waitingForInput=!1);break;case 83:case 40:"n"!==Snake.head.direction&&(Snake.head.direction="s",Engine.waitingForInput=!1);break;case 65:case 37:"e"!==Snake.head.direction&&(Snake.head.direction="w",Engine.waitingForInput=!1)}(27===b||32===b||80===b)&&Engine.pause()}),$(window).resize(function(){View.updateGameContainer(View.gameContWidth,View.gameContHeight)}),$(".back").click(function(){$(".ui-resizable-handle").hide();var a=document.getElementById("loading");a&&$(a).remove(),View.resizeMainWindow("homePos",View.initWidth,View.initHeight),Cache.session.difficulty=void 0}),$("#mainMenu span").click(function(){var a=$(this).text().toLowerCase();"high scores"===a?View.resizeMainWindow("highScoresPos",!1,!1,function(){View.loadHighScores(View.highScoresView)}):View.selectDifficulty(a),("high scores"===a||"custom"===a)&&$(".ui-resizable-handle").show()}),$("#highScoresView span").click(function(){var a=$(this).text().toLowerCase();" | "!==a&&(View.highScoresView=a,View.loadHighScores(View.highScoresView))}),$("#ready").click(function(){$(".ui-resizable-handle").hide(),View.initSession(),View.resizeMainWindow("mapsPos",!1,!1,function(){Engine.countdown(3)})}),$("#retry").click(Helpers.retry),$("#resume").click(Engine.resume),$(".goToMenu").click(function(){View.resizeMainWindow("homePos",View.initWidth,View.initHeight,function(){$("#gameOver").appendTo("#gameViewUtils").hide(),Helpers.clearLevel(),View.removeLevel(Cache.session.level),View.resetSession()})}),$("#gameContainer").resizable({handles:"se",minWidth:500,minHeight:500,resize:function(a,b){View.updateGameContainer(b.size.width,b.size.height),View.updateViewDependencies(b.size.width,b.size.height)},stop:function(a,b){if(View.alignGameWinToGrid(Cache.literals.tileWidth,Cache.literals.tileHeight),Helpers.readjustWallSlider(),"highScoresPos"===View.slidingMenuTab)if(b.originalSize.height<b.size.height)View.loadHighScores(View.highScoresView);else{var c,d,e;c=$(".highscore").length,d=(b.size.height-4*Cache.literals.tileHeight)/Cache.literals.tileHeight,e=c-d;for(var f=0;e>f;f++)$(".highscore").last().remove()}}}),$("#submit").live("click",function(){var a,b,c,d=3,e=15,f=$("#enterName #submit");if(a=$("input[name='name']").val(),b=a.length,f.hide(),-1===a.search(/\W/)&&b>=d&&e>=b){var g=$("#enterName .saving");g.show().text("Saving..."),c=function(a){$("#rank").text("Rank: "+a),$("#enterName input").attr("disabled","disabled"),g.text("Saved.")},$.ajax({type:"POST",url:location.href+"cgi-bin/hsSetter.py",data:{name:a,diff:Cache.session.difficulty,score:Cache.session.score,time:Engine.time}}).done(c)}else{var h,i;i=d>b?"Names must be at least "+d+" characters.":b>e?"Names must be less than "+(e+1)+" characters.":"Names can only contain alphanumeric characters.",h=$("#enterName .error"),h.show().text(i),setTimeout(function(){h.fadeOut(1500,function(){f.show()})},1e3)}}),View.initialize(800,540)}),PickUp.generateType=function(){var a=["dblPoints","shrink","slowTime","invincible"];return a[Math.floor(Math.random()*a.length)]},PickUp.toggleSmile=function(a){for(var b=0,c=Cache.pickUps.length;c>b;b++)if("human"===Cache.pickUps[b].type){var d=Cache.pickUps[b];Math.abs(a.tilePos[0]-d.tilePos[0])<4&&Math.abs(a.tilePos[1]-d.tilePos[1])<4?d.$html.addClass("frown"):d.$html.removeClass("frown")}},PickUp.togglePowerUp=function(){Cache.session.activePowerUp?Cache.session.activePowerUp.togglePowerUp():(Cache.session.displayedPowerUp?Cache.session.displayedPowerUp.destroy():new PickUp("powerUp").create(),Engine.powerUpToggleTime=Engine.time)},PickUp.prototype={create:function(a){var b=a?a:Helpers.findEmptyTile();return this.tilePos[0]=b[0],this.tilePos[1]=b[1],"human"===this.type?this.$html.addClass("smile"):"powerUp"===this.type&&this.$html.addClass(this.type),Helpers.drawObjToTile(this,!0),$("#level_"+Cache.session.level).append(this.$html),this},destroy:function(a){Cache.tiles[this.tilePos[0]][this.tilePos[1]].obj=void 0,"human"===this.type?Cache.session.humanCount-=1:"portal"!==this.type&&"human"!==this.type&&(Cache.session.displayedPowerUp=!1);for(var b=0,c=Cache.pickUps.length;c>b;b++)this===Cache.pickUps[b]&&Cache.pickUps.splice(b,1);a||this.$html.remove()},togglePowerUp:function(){switch(Engine.powerUpToggleTime=Engine.time,Cache.session.activePowerUp?(Cache.session.activePowerUp=!1,"shrink"!==this.type&&$(".head").removeClass("pickUp "+this.type),document.getElementById("powerUpTimeBar")&&($("#powerUpTimeBar").stop(),$("#powerUpTimeBar").remove())):(Cache.session.activePowerUp=this,"shrink"!==this.type&&$(".head").addClass("pickUp "+this.type)),this.type){case"dblPoints":Cache.session.activePowerUp?(Engine.activeDblPoints=!0,View.powerUpTimeBar(Engine.powerUpDuration)):Engine.activeDblPoints=!1;break;case"shrink":Cache.session.activePowerUp&&(Snake.segsToKill[0]&&Snake.removeDeadSegments(),Snake.segments.length>3&&Snake.killSegments(3));break;case"slowTime":Cache.session.activePowerUp?(Snake.speed*=2,View.powerUpTimeBar(Engine.powerUpDuration)):Snake.speed/=2;break;case"invincible":var a="challenge"===Cache.session.difficulty?.5:.65;Cache.session.activePowerUp?(Snake.invincible=!0,Snake.speed*=a,View.powerUpTimeBar(Engine.powerUpDuration)):(Snake.invincible=!1,Snake.speed/=a)}}};var Snake={head:void 0,initSegs:6,segsToCreate:0,segsToKill:[0,0],invincible:!1,speed:void 0,segments:[],grow:function(a){for(var b=0;a>b;b++)(new SnakeSegment).create()},move:function(){for(var a,b,c,d=0,e=Snake.segments.length;e>d;d++)if(a=Snake.segments[d],0===d?a.moveHead():a.follow(),d===e-1){var f=a.previousTilePos;Cache.tiles[f[0]][f[1]].obj=void 0}return b=Cache.tiles[Snake.head.tilePos[0]][Snake.head.tilePos[1]],c=b.obj,b.obj=Snake.head,c},animate:function(){var a=Snake.move();if(a)if(a instanceof PickUp)Snake.eat(a);else if(a instanceof Wall){if(!Snake.collide(a))return!1}else if(a instanceof SnakeSegment&&!Snake.invincible&&!a.$html.hasClass("deadSnakeSeg"))return!1;return!0},eat:function(a){"human"===a.type?(View.updateScore(10),Snake.segsToCreate+=1,Cache.session.humanCount<=Cache.session.humansPresent&&new PickUp("human").create()):"portal"===a.type?(Cache.session.segments=Snake.segments.length,Snake.head.$html.css("backgroundColor","#afafaf"),Cache.session.activePowerUp&&"shrink"!==Cache.session.activePowerUp.type&&$(".head").removeClass("pickUp "+Cache.session.activePowerUp.type),Cache.enteringPortal=!0):a.togglePowerUp(),a.destroy()},collide:function(a){var b=30;if(a.hasBomb&&!Snake.invincible){if(b=-50,a.explode(),!Snake.killSegments(4))return!1}else a.destroy(),Snake.segsToCreate+=1;return View.updateScore(b),Wall.updateNeighborWalls(),!0},killSegments:function(a,b,c){var d;!c&&Snake.segsToKill[0]>0&&Snake.removeDeadSegments(),Snake.segsToKill[0]=a,Snake.segsToKill[1]=b||Engine.time+1;for(var e=1;a>=e;e++){if(d=Snake.segments[Snake.segments.length-e],!d)return!1;d.$html.addClass("deadSnakeSeg")}return a>=Snake.segments.length?!1:!0},removeDeadSegments:function(){for(var a;Snake.segsToKill[0];)Snake.segments[Snake.segments.length-1].destroy(),Snake.segsToKill[0]-=1;a=Snake.segments[Snake.segments.length-1],Cache.tiles[a.tilePos[0]][a.tilePos[1]].obj=void 0}};SnakeSegment.prototype={create:function(){1!==Snake.segments.length&&(this.tilePos=this.leaderSegment.previousTilePos),Helpers.drawObjToTile(this,!0),$("#level_"+Cache.session.level).append(this.$html)},moveHead:function(){var a;switch(this.previousTilePos=this.tilePos.slice(0),Snake.head.direction){case"n":this.tilePos[0]=0===this.tilePos[0]?Cache.tilesYLimit:this.tilePos[0]-=1,a="top";break;case"e":this.tilePos[1]=this.tilePos[1]===Cache.tilesXLimit?0:this.tilePos[1]+=1,a="left";break;case"s":this.tilePos[0]=this.tilePos[0]===Cache.tilesYLimit?0:this.tilePos[0]+=1,a="top";break;case"w":this.tilePos[1]=0===this.tilePos[1]?Cache.tilesXLimit:this.tilePos[1]-=1,a="left"}Helpers.drawObjToTile(this,!1,a),PickUp.toggleSmile(Snake.head)},follow:function(){this.previousTilePos=this.tilePos,this.tilePos=this.leaderSegment.previousTilePos,Helpers.drawObjToTile(this,!0)},destroy:function(a){Cache.tiles[this.tilePos[0]][this.tilePos[1]].obj=void 0;for(var b=0,c=Snake.segments.length;c>b;b++)this===Snake.segments[b]&&Snake.segments.splice(b,1);a||this.$html.remove()}};var View={initWidth:0,initHeight:0,gameContWidth:0,gameContHeight:0,hsRequestTime:0,highScoresView:"classic",slidingMenuTab:"homePos",slidingMenu:{highScoresPos:"",homePos:"",helpPos:"",mapsPos:""},initialize:function(a,b){if(-1!==navigator.platform.indexOf("iPhone")||-1!==navigator.platform.indexOf("iPod"))$("#clientWarning").text("Sorry, this site requires a keyboard.");else if($.browser&&$.browser.msie&&$.browser.version<=6)$("#clientWarning").html("Your browser isn't supported here.<br />Update it!");else{$("#clientWarning").remove(),$("#pauseMenu, #gameOver, .ui-resizable-handle").hide(),$("#gameContainer, #credit").show(),a=a>500?a:500,a-=a%Cache.literals.tileWidth,b=b>500?b:500,b-=b%Cache.literals.tileHeight,View.initWidth=a,View.initHeight=b,View.updateGameContainer(a,b),View.updateViewDependencies(a,b);var c=$(window).width()/1.3,d=$(window).height()/1.3;c-=c%Cache.literals.tileWidth,d-=d%Cache.literals.tileHeight,c=c>a?c:a+100,d=d>b?d:b+100,c=1500>c?c:1500,d=1100>d?d:1100,$("#gameContainer").resizable("option",{maxWidth:c,maxHeight:d})}},loadHighScores:function(a){var b=(new Date).getTime();if(b-View.hsRequestTime>250){var c,d,e;View.hsRequestTime=(new Date).getTime(),c=4*Cache.literals.tileHeight,d=Math.floor((View.gameContHeight-c)/Cache.literals.tileHeight),$("#"+a+"View").css("text-decoration","underline").siblings().css("text-decoration","none"),document.getElementById("loading")||$("#canvas").append('<div id="loading">Loading...</div>'),e=function(a){var b,c,d=1;"string"==typeof a&&(a=a.split("\n"),a.pop()),$(".highscore, #loading").remove();for(var e=0,f=a.length;f>e;e++)a[e]=a[e].split(","),c=View.formatTimeStr(a[e][2]),c.length<3&&(c+="s"),b=$("<tr class='highscore'><td>"+d+"</td><td>"+a[e][0]+"</td><td>"+a[e][1]+"</td><td>"+c+"</td><td>"+a[e][3]+"</td></tr>"),$("#highScores table").append(b),d+=1},$.ajax({type:"POST",url:location.href+"cgi-bin/hsGetter.py",data:{amt:d,diff:a}}).done(e)}},alignMenuTabs:function(a){var b,c=0;for(b in View.slidingMenu)View.slidingMenu.hasOwnProperty(b)&&(View.slidingMenu[b]=c,c-=a)},formatTimeStr:function(a){var b;return a/60>=1?(b=Math.floor(a/60),a-=60*b,10>a&&(a="0"+a),b+":"+a):a},alignGameWinToGrid:function(a,b){var c=View.gameContWidth,d=View.gameContHeight;c-=View.gameContWidth%a,d-=View.gameContHeight%b,View.updateGameContainer(c,d),View.updateViewDependencies(c,d)},centerElement:function(a,b){var c,d;return b=b||$("#gameContainer"),d="static"===a.css("position")?"marginTop":"top",c=(b.height()-a.outerHeight())/2,a.css(d,c+"px"),a},updateChallengeInfo:function(a,b){var c="Hidden Humans: "+b;"challenge"===Cache.session.difficulty&&(c="Level: "+a+" | "+c),$("#snakeHUD .challengeInfo").text(c)},updateGameContainer:function(a,b){var c=($(document).height()-b)/2;$("#gameContainer").css("top",c+"px").width(a).height(b),View.gameContWidth=a,View.gameContHeight=b},updateViewDependencies:function(){var a=$("#slidingMenu"),b=$(".centerBox"),c=$("#canvas, #slidingMenu"),d=$("#canvas, #highScores, #home, #help, #maps .levelContainer, #gameViewUtils");return function(e,f){e&&(d.width(e),View.alignMenuTabs(e),a.css("left",View.slidingMenu[View.slidingMenuTab]+"px")),f&&c.height(f),b.each(function(){View.centerElement($(this))})}}(),selectDifficulty:function(a){Cache.session.difficulty=a,$("#selectedDifficulty").text("difficulty: "+a),"custom"===a?($(".challengeInfo, #instructions, #pickUpCtrlInfo").hide(),$("#custom, #snakeHUD .challengeInfo").show(),Helpers.readjustWallSlider(),View.centerElement($("#help .centerBox")),View.resizeMainWindow("helpPos",!1,!1)):($("#custom").hide(),$("#instructions, #pickUpCtrlInfo").show(),"classic"===a?$(".challengeInfo").hide():$(".challengeInfo").show(),View.resizeMainWindow("helpPos",Cache.literals.compWidth,Cache.literals.compHeight))},resizeMainWindow:function(){var a=$("#gameContainer"),b=function(a,b){View.slidingMenuTab=a,$("#slidingMenu").animate({left:View.slidingMenu[a]+"px"},{duration:"slow",queue:!1,complete:b})};return function(c,d,e,f){d=d?d:View.gameContWidth,e=e?e:View.gameContHeight,a.animate({width:d+"px",height:e+"px",top:($(document).height()-e)/2+"px"},{duration:"slow",queue:!1,step:function(a,b){"width"===b.prop?(View.gameContWidth=a,View.updateViewDependencies(a)):"height"===b.prop&&(View.gameContHeight=a,View.updateViewDependencies(!1,a))}}),View.alignMenuTabs(d),b(c,f)}}(),updateScore:function(a){a=Engine.activeDblPoints?2*a:a,Cache.session.score+=a,$("#scoreBar").text(Cache.session.score+"pts"),a=a>0?"+"+a:a,$("#pointAddition").html("<span>"+a+"pts<span>"),Cache.addedPtsTimer&&clearTimeout(Cache.addedPtsTimer),Cache.addedPtsTimer=setTimeout(function(){$.browser&&$.browser.msie&&$.browser.version<9?$("#pointAddition").html("&nbsp;"):$("#pointAddition span").fadeOut()},1e3)},buildLevel:function(){$('<div id="levelContainer_'+Cache.session.level+'" class="levelContainer"></div>').width(View.gameContWidth).append('<div id="level_'+Cache.session.level+'" class="level"><div id="countdown"><div>3</div></div></div>').appendTo("#mapsIE7Fix"),"challenge"===Cache.session.difficulty?$("#countdown").prepend("<div id='currentLevel'>Level "+Cache.session.level+"</div>"):View.centerElement($("#countdown div"),$("#countdown")),View.centerElement($("#countdown"))},powerUpTimeBar:function(a){a*=1e3,document.getElementById("powerUpTimeBar")||$("<div id='powerUpTimeBar'></div>").appendTo("#powerUpPlaceHolder"),$("#powerUpTimeBar").animate({width:"0px"},a,function(){$(this).remove()})},initSession:function(){switch("custom"!==Cache.session.difficulty&&(Snake.segsToCreate=Snake.initSegs,Engine.powerUpDuration=5),Cache.session.difficulty){case"classic":Snake.speed=76,Cache.session.humansPresent=3;break;case"challenge":Snake.speed=120,Cache.session.humansPresent=0;var a=Helpers.getMaxWalls();Cache.session.finalLevel=a/Cache.literals.wallMultiplier;break;case"custom":Snake.segsToCreate=$("#startingLengthSlider").slider("value")-1,Cache.session.humansPresent=$("#humansPresentSlider").slider("value"),Engine.powerUpDuration=$("#powerUpDurationSlider").slider("value"),Snake.speed=10*($("#speedSlider").slider("option","max")-$("#speedSlider").slider("value"))+20}Helpers.buildTiles(),View.buildLevel(),Helpers.prepareLevel(Snake.initSegs,Cache.session.humansPresent)},resetSession:function(){Cache.resetCache(),Engine.powerUpToggleTime=0,$("#pauseMenu").hide(),$("#clock").text(Engine.time=0),$("#scoreBar").text(Cache.session.score+"pts")},gameOver:function(){document.getElementById("powerUpTimeBar")&&$("#powerUpTimeBar").stop(),$("#score").text("Score: "+Cache.session.score),$("#rank").text("Rank: -"),"custom"===Cache.session.difficulty?$("#rank, #enterName").hide():Cache.session.score>=100?($("input[name='name']").val("").removeAttr("disabled"),$("#enterName .saving").hide(),$("#rank, #enterName, #submit").show()):$("#rank, #enterName").hide(),$("#gameOver").appendTo("#level_"+Cache.session.level).width(View.gameContWidth),$("#gameOver").show(),View.centerElement($("#gameOver")),$("#enterName input").focus()},removeLevel:function(a){$("#levelContainer_"+a||Cache.session.level).remove()}};Wall.generateWallPattern=function(a){var b,c,d,e,f,g=4,h=0,i=[1,2,3,4],j=[];for(f=function(a,b){for(var c=0,d=b.length;d>c;c++)if(a===b[c])return!1;return!0};a>h;){if(h%g===0){if(e=Helpers.findEmptyTile(),!f(e,j))continue;if(Helpers.getSurroundingObjs(e,Wall).length>2){j.push(e);continue}}else{c=i.slice(0);do{if(0===c.length){if(j.push(b.tilePos),b=Cache.walls[Math.floor(Math.random()*Cache.walls.length)],!f(b.tilePos,j))continue;c=i.slice(0)}switch(d=c[Math.floor(Math.random()*c.length)],e=b.tilePos.slice(0),d){case 1:e[0]-=1;break;case 2:e[1]+=1;break;case 3:e[0]+=1;break;case 4:e[1]-=1}if(e[0]<1||e[1]<0||e[0]>Cache.tilesYLimit||e[1]>Cache.tilesXLimit||Cache.tiles[e[0]][e[1]].obj||Helpers.getSurroundingObjs(e,Wall).length>2){j.push(e),e=!1;for(var k=0,l=c.length;l>k;k++)d===c[k]&&c.splice(k,1)}}while(!e)}b=new Wall(e),b.build(),h+=1}},Wall.plantBombs=function(a){a=a||0===a?a:.5;var b,c=Math.floor(Cache.walls.length*a);for(Cache.session.gems=Cache.walls.length-c,View.updateChallengeInfo(Cache.session.level,Cache.session.gems);c;)b=Cache.walls[Math.floor(Math.random()*Cache.walls.length)],b.hasBomb||(b.hasBomb=!0,c-=1)},Wall.updateBombHints=function(){for(var a=0,b=Cache.walls.length;b>a;a++){for(var c=0,d=Helpers.getSurroundingObjs(Cache.walls[a].tilePos,Wall),e=0,f=d.length;f>e;e++)d[e].hasBomb&&(c+=1);Cache.walls[a].$html.text(c)}},Wall.updateNeighborWalls=function(){for(var a,b,c,d=Helpers.getSurroundingObjs(Snake.head.tilePos,Wall),e=0,f=d.length;f>e;e++)if(a=0,b=Helpers.getSurroundingObjs(d[e].tilePos,Wall),0===b.length&&d[e].hasBomb)c=d[e].tilePos,d[e].explode(),new PickUp("human").create(c);else{for(var g=0,h=b.length;h>g;g++)b[g].hasBomb&&(a+=1);d[e].$html.text(a)}},Wall.prototype={build:function(){Helpers.drawObjToTile(this,!0),$("#level_"+Cache.session.level).append(this.$html)},explode:function(){var a=$("<div class='explosion'></div>");a.css({left:Cache.tiles[this.tilePos[0]][this.tilePos[1]].left-Cache.literals.tileWidth,top:Cache.tiles[this.tilePos[0]][this.tilePos[1]].top-Cache.literals.tileHeight}),a.appendTo("#level_"+Cache.session.level),this.destroy(),setTimeout(function(){a.remove()},200)},destroy:function(a){Cache.tiles[this.tilePos[0]][this.tilePos[1]].obj=void 0;for(var b=0,c=Cache.walls.length;c>b;b++)this===Cache.walls[b]&&Cache.walls.splice(b,1);this.hasBomb||(Cache.session.gems-=1,View.updateChallengeInfo(Cache.session.level,Cache.session.gems),0===Cache.session.gems&&"challenge"===Cache.session.difficulty&&new PickUp("portal").create()),a||this.$html.remove()}};